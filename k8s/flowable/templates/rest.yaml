{{- if .Values.rest.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "flowable.template" . }}
  labels:
    {{ include "flowable.defaultlabels" . }}
spec:
  replicas: {{ .Values.rest.replicas }}
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ include "flowable.template" . }}
      app.kubernetes.io/instance: {{ .Release.Name }}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ include "flowable.template" . }}
        app.kubernetes.io/instance: {{ .Release.Name }}
    spec:
      initContainers:
      - name: check-db-ready
        image: postgres:9.6.5
        command: ['sh', '-c', 'until pg_isready -h {{ .Values.postgres.service.name }} -p 5432; do echo waiting for database; sleep 2; done;']
      containers:
      - name: {{ include "flowable.template" . }}
        image: "{{ .Values.rest.image.repository }}:{{ .Values.rest.image.tag }}"
        imagePullPolicy: {{ .Values.rest.image.pullPolicy }}
        ports:
        - containerPort: 8080
        readinessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
            httpHeaders:
            - name: Authorization
              value: Basic YWRtaW46dGVzdA==
          initialDelaySeconds: 60
          timeoutSeconds: 5
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
            httpHeaders:
            - name: Authorization
              value: Basic YWRtaW46dGVzdA==
          initialDelaySeconds: 60
          timeoutSeconds: 10
          failureThreshold: 10
        envFrom:
        - configMapRef:
            name: {{ include "flowable.template" . }}-configmap
        volumeMounts:
        resources:
{{ toYaml .Values.rest.resources | indent 10 }}
      restartPolicy: Always
      volumes:
---
apiVersion: v1
kind: Service
metadata:
  name: {{ .Values.rest.service.name }}
  labels:
    {{ include "flowable.defaultlabels" . }}
spec:
  clusterIP: None
  selector:
    app.kubernetes.io/name: {{ include "flowable.template" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
  ports:
  - name: http
    protocol: TCP
    port: 8080
    targetPort: 8080
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "flowable.template" . }}-configmap
data:
  JAVA_OPTS: "{{ .Values.rest.javaOpts }} -Djava.security.egd=file:/dev/./urandom"
  SERVER_SERVLET_CONTEXT_PATH: {{ .Values.rest.contextUrl | quote }}
  SERVER_SERVLET_SESSION_TIMEOUT: 1h
  SPRING_DATASOURCE_DRIVER-CLASS-NAME: org.postgresql.Driver
  SPRING_DATASOURCE_URL: jdbc:postgresql://{{ .Values.postgres.service.name }}:5432/{{ .Values.flowable.database.name }}
  SPRING_DATASOURCE_USERNAME: {{ .Values.flowable.database.username }}
  SPRING_DATASOURCE_PASSWORD: {{ .Values.flowable.database.password }}
  FLOWABLE_REST_APP_ADMIN_USER-ID: rest-admin
  FLOWABLE_REST_APP_ADMIN_PASSWORD: test
  FLOWABLE_REST_APP_ADMIN_FIRST-NAME: Rest
  FLOWABLE_REST_APP_ADMIN_LAST-NAME: Admin
{{- end }}